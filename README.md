# PDF処理ツール

このツールは、PDFファイルを処理、変更、および管理するためのPythonアプリケーションです。特定の条件に基づいてデータを抽出し、リネームし、ファイルを結合する機能を提供します。このアプリケーションは、PDFの操作、テキストの抽出、その他の情報の管理、およびグラフィカルユーザーインターフェイス（GUI）操作を処理するためのいくつかのライブラリを使用しています。

## 目次

1. [必要環境](#必要環境)
2. [インストール](#インストール)
3. [使用方法](#使用方法)
4. [コード概要](#コード概要)
5. [クラスと関数の説明](#クラスと関数の説明)
6. [注意事項](#注意事項)
7. [休日.csv のサンプル](#休日csv-のサンプル)
8. [アプリケーションのビルド方法](#アプリケーションのビルド方法)
9. [テストと品質確認](#テストと品質確認)

## 必要環境

- Windows
- Python 3.9.13
- 以下のPythonライブラリが必要です:
  - `tkinter`
  - `PyPDF2`
  - `pdfminer`
  - `reportlab`
  - `dateutil`

## インストール

1. Python 3.9.13をインストールします。
2. 必要なライブラリをインストールします。以下のコマンドを使用してください。

    ```bash
    pip install PyPDF2 pdfminer.six reportlab python-dateutil
    ```

## 使用方法

1. このプログラムを実行する前に、`休日.csv`という名前のファイルが同じディレクトリに存在する必要があります。`休日.csv`ファイルには、休日の日付が`YYYY/MM/DD`形式で記載されている必要があります。

2. プログラムを実行するには、以下のコマンドを使用します。

    ```bash
    python renamePdf.py
    ```

3. GUIが起動し、「フォルダ参照」ボタンをクリックしてPDFファイルが格納されているフォルダを選択します。

4. 選択したフォルダ内のPDFファイルを処理し、必要に応じてリネームや結合が行われます。

## コード概要

このアプリケーションは、複数のPDFファイルを処理し、指定された条件に基づいてデータを抽出して処理を行います。PDFの処理には、`pdfminer`と`PyPDF2`ライブラリを使用しています。また、`reportlab`ライブラリを用いてPDFファイルへの書き込みも行います。

- **GUIの作成**: `tkinter`ライブラリを使用して、フォルダを選択するためのGUIを提供します。
- **PDF処理クラス**: PDFファイルの読み込み、データ抽出、リネーム、結合を行うための複数のクラスが定義されています。
- **ファイル処理のメインロジック**: メイン関数`main_process()`では、PDFファイルの内容を解析し、必要な情報を抽出します。

## クラスと関数の説明

### `Sheet` クラス

`Sheet`は、PDF処理のための基本クラスであり、以下のメソッドを持ちます：

- `trim_end_of_word()`: 文字列の末尾から空白を取り除くメソッド。
- `extraction_for_quotation()`: 見積書の情報を抽出するメソッド。
- `calculate_confirm_day()`: 発送日から確定日を計算するメソッド。
- `write_confirm_day()`: 確定日をPDFに書き込むメソッド。
- `create_page_number_pdf()`: ページ番号を付けたPDFを作成するメソッド。
- `get_page_size()`: PDFページのサイズ（幅と高さ）を取得するメソッド。
- `rename_file()`: ファイル名を変更するメソッド。

### その他のクラス

他にも、特定のPDFファイルに対する処理を行うためのクラスが定義されています：

- `Final_check_sheet` クラス: 最終確認票用の処理を行う。
- `Detail_sheet` クラス: 仕様明細書の処理を行う。
- `Quotation_sheet` クラス: 見積書の処理を行う。
- `Change_specifications_sheet` クラス: 仕様変更の仕様明細書を処理する。
- `Cancel_sheet` クラス: キャンセル明細書の処理を行う。

### `main_process()` 関数

指定されたフォルダ内のPDFファイルを処理し、適切なクラスのインスタンスを生成して処理を行います。

### `merge_files_for_posting()` 関数

処理後のPDFファイルを条件に基づいて結合する関数です。

## 注意事項

- `holiday`リストを定義するために、`休日.csv`ファイルが必要です。
- `reportlab`で使用するフォントがシステムにインストールされていることを確認してください。

## `休日.csv` のサンプル

以下は、`休日.csv`ファイルの内容のサンプルです。日付と祝日の名称が記載されています。

| date       | holiday_name            |
|------------|-------------------------|
| 2024/01/01 | 元日                    |
| 2024/01/08 | 成人の日                |
| 2024/02/11 | 建国記念の日            |
| 2024/02/12 | 建国記念の日 振替休日  |
| 2024/03/20 | 春分の日                |
| ...        | ...                     |

上記のように、5行目以降のデータは省略されていますが、実際のファイルには祝日が引き続き記載されています。

## アプリケーションのビルド方法

このアプリケーションは、`cx_Freeze`を使用して `.exe`形式にビルドできます。これにより、Pythonがインストールされていない環境でもアプリケーションを実行することができます。

### ビルド手順

1. **`cx_Freeze`のインストール**

以下のコマンドを使用して、`cx_Freeze`をインストールします。

```bash
pip install cx_Freeze
```

2. **ビルドの準備**

プロジェクトディレクトリに `setup.py` ファイルが存在していることを確認します。`setup.py`ファイルには、アプリケーションのビルドに必要な設定が記述されています。

3. **コマンドを実行してビルドを開始**

コマンドプロンプトまたはターミナルを開き、`setup.py`が存在するディレクトリに移動します。そして、次のコマンドを実行します。
```bash
python setup.py build
```
このコマンドは、`build`という名前のフォルダを作成し、その中に `.exe` ファイルを生成します。

4. **ビルド結果の確認**

ビルドが成功すると、`build` フォルダ内に `.exe` ファイルが生成されます。このファイルを実行することで、Python環境がなくてもアプリケーションを使用できます。

### 注意

- ビルド時には、Pythonスクリプトに依存するすべてのファイル（例：アイコンファイルやリソースファイル）が正しいパスに存在する必要があります。
- 必要に応じて、setup.pyファイル内の includes と excludes リストを調整してください。

- 生成された `.exe` ファイルは、他のPC環境でもそのまま動作します。ただし、プログラムの機能に必要なリソース（例: フォントファイル、アイコンファイル、`休日.csv` など）は同じディレクトリに配置する必要があります。

- ビルド後、`dist` フォルダにアプリケーションの実行ファイルが配置されます。このフォルダ全体を配布用として他の環境に持ち運ぶことができます。

### ビルドに関する追加情報

- **`setup.py` の `includes` と `excludes` リスト**:
  `includes` リストには、アプリケーションで使用する必要があるすべてのPythonモジュールやパッケージを指定します。逆に、`excludes` リストには、不要なモジュールやパッケージを指定してビルドサイズを減らすことができます。

- **`icon` ファイルの指定**:
  アイコンファイル (`icon.ico`) を指定することで、生成される `.exe` ファイルのアイコンをカスタマイズすることができます。`setup.py`の`Executable`設定で、`icon`オプションを使用して指定します。

- **`include_files` の設定**:
  `include_files` オプションを使うことで、ビルドに含める追加のファイルやフォルダ（アイコンやリソースファイルなど）を指定することができます。

### トラブルシューティング

- **`ModuleNotFoundError` エラーが発生する場合**:
  `setup.py` の `includes` リストに欠落しているモジュールがないか確認してください。必要なモジュールをインクルードすることで解決できます。

- **アイコンが正しく表示されない場合**:
  `icon.ico` ファイルが指定したパスに存在するか確認してください。また、ファイル形式が `.ico` であることも確認してください。

- **ビルドが失敗する場合**:
  エラーメッセージを確認し、`setup.py`の設定を見直すか、依存関係が正しくインストールされているか確認してください。特に `cx_Freeze` は Pythonのバージョンに依存するため、互換性のあるバージョンを使用してください。

このREADMEを参考にして、PDF処理ツールを簡単にセットアップし、活用してください。必要に応じて、コードや設定をカスタマイズすることで、特定のニーズに応じた機能拡張が可能です。

## テストと品質確認

Windows を対象としたアプリケーションですが、macOS などの開発環境でもコードの変更や品質確認が行いやすいように、自動テストと Lint ツールを追加しています。既存コードの挙動を前提に、代表的な機能を対象としたユニットテストのみを実装しています。

### セットアップ手順

1. 仮想環境を作成して有効化します。
   ```bash
   python -m venv venv
   source venv/bin/activate  # PowerShell の場合は .\venv\Scripts\Activate.ps1
   ```

2. 開発用の依存関係をインストールします。
   ```bash
   pip install -r requirements-dev.txt
   ```

### 利用可能なコマンド

プロジェクトには `Makefile` が含まれており、以下のコマンドが利用できます：

```bash
# ヘルプを表示
make help

# 仮想環境を作成
make venv

# 開発環境をセットアップ（依存関係インストール + pre-commit設定）
make setup-dev

# テストを実行
make test

# カバレッジ付きでテストを実行
make test-cov

# Linterを実行
make lint

# コードを自動整形
make format

# 型チェックを実行
make type-check

# 全チェックを実行（lint + type-check + test）
make check

# CI パイプラインをローカルで実行
make ci
```

### 自動テスト

`pytest` でユニットテストを実行します。
```bash
# 基本的なテスト実行
pytest

# または Makefile を使用
make test

# カバレッジ付きでテスト実行
make test-cov
```

テストは ReportLab の標準フォントのみを利用して PDF を生成するため、パスやフォントに Windows 固有の依存はありません。

### Lint（静的解析）

`ruff` を利用して主要なスタイル違反や未使用インポートを検出できます。
```bash
# Linter実行
ruff check .

# または Makefile を使用
make lint

# 自動修正可能な問題を修正
ruff check . --fix

# コードを自動整形
make format
```

### 型チェック

`mypy` を使用して型チェックを実行できます。
```bash
# 型チェック実行
make type-check
```

### Pre-commit フック

開発環境をセットアップすると、コミット前に自動的にコード品質チェックが実行されます。
```bash
# pre-commit フックをインストール
make setup-dev

# 手動でpre-commitを実行
pre-commit run --all-files
```

### 継続的インテグレーション

ローカルでCI環境と同等のチェックを実行できます。
```bash
make ci
```

これにより、コード整形、Lint、型チェック、テスト（カバレッジ付き）が順次実行されます。

`pytest`、`ruff`、`mypy` は共通して `requirements-dev.txt` に含まれているため、macOS からでも同じ手順でセットアップと実行が可能です。
